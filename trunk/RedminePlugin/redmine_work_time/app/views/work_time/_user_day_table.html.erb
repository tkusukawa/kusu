<table border="1" id="time_input_table">
  <tr align="center" style="background:#ddd;">
    <td>
      <div style="position:relative;height:25px;">
        <div style="posision:absolute;top:3px;left:20px;width:200px;font-size:1.5em;">
          <%= @this_year %>/<%= @month_names[@this_month-1]%>/<%=@this_day%><br>
        </div>
      </div>
    </td>
    <td><%=l(:work_time)%></td>
    <td><%=l(:field_activity)%></td>
    <td><%=l(:field_comments)%></td>
  </tr>
<%
# この日のチケット作成を洗い出す
day_total = 0;
worked_issues = [];
next_date = @this_date+1
t1 = Time.local(@this_date.year, @this_date.month, @this_date.day);
t2 = Time.local(next_date.year, next_date.month, next_date.day);
issues = Issue.find(:all, :conditions=>["author_id=:u and created_on>=:t1 and created_on<:t2",
                                       {:u=>@this_uid, :t1=>t1, :t2=>t2}]);
issues.each do |issue|
  worked_issues |= [issue.id];
end
# この日のチケット操作を洗い出す
journals = Journal.find(:all, :conditions=>
             ["journalized_type='Issue' and user_id=:u and created_on>=:t1 and created_on<:t2",
             {:u=>@this_uid, :t1=>t1, :t2=>t2}]);
journals.each do |j|
  worked_issues |= [j.journalized_id];
end

input_issues = @disp_issues;
input_prj_issues = @disp_prj_issues;
worked_issues.each do |i|
  next if input_issues.include?(i); #既存の項目は追加しない
  issue = Issue.find(i);
  p = issue.project_id;
  next if @restrict_project && p != @restrict_project; #プロジェクト制限チェック
  input_issues.push(i);
  work_issues |= [i];
  if input_prj_issues.key?(p) then
    input_prj_issues[p].push([i, -1]); #既存ハッシュに要素追加
  else
    input_prj_issues[p] = [[i, -1]]; #新規ハッシュに配列を追加
  end
end

prj_odr = WtProjectOrders.find(:all, :order=>"dsp_pos", :conditions=>["prj=:p and uid=:u",{:p=>@project.id, :u=>@this_uid}]);

prj_odr.each do |po|
 dsp_prj = po.dsp_prj;
 dsp_pos = po.dsp_pos;
 next if input_prj_issues.key?(dsp_prj) == false;
 prj = Project.find(dsp_prj);
 prj_day_sum = TimeEntry.sum(:hours, :conditions=>
             ["user_id=:u and project_id=:p and spent_on=:d", 
             {:u => @this_uid, :p=>dsp_prj, :d=>@this_date}]);
%>
<tr style="background:#000;color:#fff;">
  <td><%=prj.name%></td>
  <td><%=prj_day_sum%></td>
  <td></td>
  <td></td>
</tr>
<%
 input_prj_issues[dsp_prj].each do |issue_odr|
  issue_id = issue_odr[0];
  issue_color = worked_issues.include?(issue_id) ? "#cfc" : "#fff";
  issue = Issue.find(issue_id);
  issueHtml = issue.closed? ? "<del>"+issue.to_s+"</del>" : issue.to_s;

  time_entries = TimeEntry.find(:all, :conditions=>
             ["user_id=:u and issue_id=:i and spent_on=:d", 
             {:u => @this_uid, :i=>issue_id, :d=>@this_date}]);
  if time_entries.size == 0 then
%>
<!-- 工数エントリなし -->
<tr>
  <td style="background:<%=issue_color%>;">
    <%= link_to(issueHtml, :controller=>"issues", :action=>"show", :id=>issue.id) %>
    <%= print_issue_cost(issue) %>
  </td>
  <td>
    <%= text_field_tag("new_hour0_"+issue_id.to_s, "", :size=>5) %>
  </td>
  <td>
    <%= select_tag "new_act0_"+issue.id.to_s, @activity_options, :required => true %>
  </td>
  <td>
    <%= text_field_tag("new_cmnt0_"+issue_id.to_s, "", :size=>80)%>
  </td>
</tr>
<%
  else
    cost = time_entries.sum{|e| e.hours}
    time_entries.each do |t|
    day_total += t.hours;
%>
<!-- 工数エントリあり -->
<tr>
  <td style="background:<%=issue_color%>;">
    <%= link_to(issueHtml, :controller=>"issues", :action=>"show", :id=>issue.id) %>
    <%= print_issue_cost(issue) %>
  </td>
  <td>
    <%= text_field_tag("hour"+t.id.to_s, t.hours, :size=>5) %>
  </td>
  <td>
<%
activity = "";
Enumeration.get_values("ACTI").each do |enm|
  if enm.id == t.activity_id then
    activity += "<option value="+enm.id.to_s+" selected>"+enm.name
  else
    activity += "<option value="+enm.id.to_s+">"+enm.name
  end
end
%>
    <%= select_tag "act"+t.id.to_s, activity, :required => true %>
  </td>
  <td>
    <%= text_field_tag("cmnt"+t.id.to_s, t.comments, :size=>80)%>
  </td>
</tr>
<%
   end
  end
 end
end
%>
<tr align="center" id="time_input_table_bottom" style="background:#ddd;">
  <td>&nbsp;</td>
  <td><%=sprintf("%1.1f",day_total)%></td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
</tr>
</table>
